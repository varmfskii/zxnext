<!DOCTYPE HTML>

<!--Converted with LaTeX2HTML 2019 (Released January 1, 2019) -->
<HTML lang="EN">
<HEAD>
<TITLE>Interrupts</TITLE>
<META NAME="description" CONTENT="Interrupts">
<META NAME="keywords" CONTENT="zxnext_notes">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="viewport" CONTENT="width=device-width, initial-scale=1.0">
<META NAME="Generator" CONTENT="LaTeX2HTML v2019">

<LINK REL="STYLESHEET" HREF="zxnext_notes.css">

<LINK REL="next" HREF="node117.html">
<LINK REL="previous" HREF="node90.html">
<LINK REL="next" HREF="node117.html">
</HEAD>

<BODY >

<DIV CLASS="navigation"><!--Navigation Panel-->
<A
 HREF="node117.html">
<IMG WIDTH="37" HEIGHT="24" ALT="next" SRC="next.png"></A> 
<A
 HREF="zxnext_notes.html">
<IMG WIDTH="26" HEIGHT="24" ALT="up" SRC="up.png"></A> 
<A
 HREF="node115.html">
<IMG WIDTH="63" HEIGHT="24" ALT="previous" SRC="prev.png"></A> 
<A ID="tex2html1001"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALT="contents" SRC="contents.png"></A> 
<A ID="tex2html1003"
  HREF="node177.html">
<IMG WIDTH="43" HEIGHT="24" ALT="index" SRC="index.png"></A> 
<BR>
<B> Next:</B> <A
 HREF="node117.html">Raspberry Pi0 Acceleration</A>
<B> Up:</B> <A
 HREF="zxnext_notes.html">ZX Spectrum Next Programming</A>
<B> Previous:</B> <A
 HREF="node115.html">Summary</A>
 &nbsp; <B>  <A ID="tex2html1002"
  HREF="node1.html">Contents</A></B> 
 &nbsp; <B>  <A ID="tex2html1004"
  HREF="node177.html">Index</A></B> 
<BR>
<BR></DIV>
<!--End of Navigation Panel-->

<H1><A ID="SECTION00800000000000000000">
Interrupts</A>
</H1>
CPU processing of interrupts is enabled using the EI instruction and
disabled with the DI instruction. Interrupts can happen at any time
and should preserve register contents.  If none of your code uses the
alternate registers the EXX and EX AF,AF’ instructions can make this
faster and easier. Upon completion of your interrupt routine you
should call the RTI instruction and re-enable interrupts.

<P>
IM0 – When an interrupt is received by the CPU it disables interrupts
and executes the instruction placed on the bus by the interrupting
device and (no known use on the Next) It is enabled with the IM0
instruction and enabling interrupts (EI).

<P>
IM1 – When an interrupt is received, the CPU disables interrupts and
jumps to an interrupt handler at $0038 (normally in ROM). The ROM
interrupt handler updates the frame counter and scans the
keyboard. This is the default interrupt handling method for the ZX
Spectrum and is probably the method to use if you don’t need the ROMs
for anything. It is enabled using the IM1 instruction and enabling
interrupts.

<P>
IM2 – When the CPU receives an interrupt it disables interrupts and
jumps to an interrupt routine starting at the contents of the jump
table at I. The start of the interrupt routine is the contents of
I*$100+bus and I*$100+bus+1. Most devices that can supply interrupts
on the ZX Spectrum leave the data bus in a floating state.  As a
result the interpreted state of the data bus while generally $FF is
not entirely predictable.  The solution to place your interrupt
routine at an address where the MSB and LSB are the same ($0101,
$0202, … $FFFF) then place 257 copies of that value in a block
starting at I*$100 (you can set the value of the I register).

<P>
Code:
<PRE>
;; my program
org $8000
;; enable interrupt mode im2
ld i,$fe
im2
ei
;; program body
;; interrupt routine
handler:
;; preserve registers used
;; handle interrupt
;; restore registers
ei
rti
;; jump to interrupt routine
org $fdfd
jp handler
;; im2 jump table
org $fe00 ; not actually legal
defs $101,$fd
</PRE>

<DIV CLASS="navigation"><HR>
<!--Navigation Panel-->
<A
 HREF="node117.html">
<IMG WIDTH="37" HEIGHT="24" ALT="next" SRC="next.png"></A> 
<A
 HREF="zxnext_notes.html">
<IMG WIDTH="26" HEIGHT="24" ALT="up" SRC="up.png"></A> 
<A
 HREF="node115.html">
<IMG WIDTH="63" HEIGHT="24" ALT="previous" SRC="prev.png"></A> 
<A ID="tex2html1001"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALT="contents" SRC="contents.png"></A> 
<A ID="tex2html1003"
  HREF="node177.html">
<IMG WIDTH="43" HEIGHT="24" ALT="index" SRC="index.png"></A> 
<BR>
<B> Next:</B> <A
 HREF="node117.html">Raspberry Pi0 Acceleration</A>
<B> Up:</B> <A
 HREF="zxnext_notes.html">ZX Spectrum Next Programming</A>
<B> Previous:</B> <A
 HREF="node115.html">Summary</A>
 &nbsp; <B>  <A ID="tex2html1002"
  HREF="node1.html">Contents</A></B> 
 &nbsp; <B>  <A ID="tex2html1004"
  HREF="node177.html">Index</A></B> </DIV>
<!--End of Navigation Panel-->

</BODY>
</HTML>
