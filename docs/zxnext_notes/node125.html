<!DOCTYPE HTML>

<!--Converted with LaTeX2HTML 2020.2 (Released July 1, 2020) -->
<HTML lang="en">
<HEAD>
<TITLE>Interrupts</TITLE>
<META NAME="description" CONTENT="Interrupts">
<META NAME="keywords" CONTENT="zxnext_notes">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="viewport" CONTENT="width=device-width, initial-scale=1.0">
<META NAME="Generator" CONTENT="LaTeX2HTML v2020.2">

<LINK REL="STYLESHEET" HREF="zxnext_notes.css">

<LINK REL="next" HREF="node126.html">
<LINK REL="previous" HREF="node99.html">
<LINK REL="next" HREF="node126.html">
</HEAD>

<BODY >

<DIV CLASS="navigation"><!--Navigation Panel-->
<A
 HREF="node126.html">
<IMG WIDTH="37" HEIGHT="24" ALT="next" SRC="next.png"></A> 
<A
 HREF="zxnext_notes.html">
<IMG WIDTH="26" HEIGHT="24" ALT="up" SRC="up.png"></A> 
<A
 HREF="node124.html">
<IMG WIDTH="63" HEIGHT="24" ALT="previous" SRC="prev.png"></A> 
<A ID="tex2html1078"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALT="contents" SRC="contents.png"></A> 
<A ID="tex2html1080"
  HREF="node193.html">
<IMG WIDTH="43" HEIGHT="24" ALT="index" SRC="index.png"></A> 
<BR>
<B> Next:</B> <A
 HREF="node126.html">Raspberry Pi0 Acceleration</A>
<B> Up:</B> <A
 HREF="zxnext_notes.html">ZX Spectrum Next Programming</A>
<B> Previous:</B> <A
 HREF="node124.html">Summary</A>
 &nbsp; <B>  <A ID="tex2html1079"
  HREF="node1.html">Contents</A></B> 
 &nbsp; <B>  <A ID="tex2html1081"
  HREF="node193.html">Index</A></B> 
<BR>
<BR></DIV>
<!--End of Navigation Panel-->

<H1><A ID="SECTION00800000000000000000">
Interrupts</A>
</H1>
The Z80 has three different hardware interrupt signals:
<!-- MATH
 $\overline{\hbox{RESET}}$
 -->
<SPAN CLASS="MATH"><IMG STYLE="height: 2.22ex; vertical-align: -0.11ex; " SRC="img52.svg"
 ALT="$\overline{\hbox{RESET}}$"></SPAN>, <!-- MATH
 $\overline{\hbox{NMI}}$
 -->
<SPAN CLASS="MATH"><IMG STYLE="height: 2.22ex; vertical-align: -0.11ex; " SRC="img53.svg"
 ALT="$\overline{\hbox{NMI}}$"></SPAN>, and <!-- MATH
 $\overline{\hbox{INT}}$
 -->
<SPAN CLASS="MATH"><IMG STYLE="height: 2.22ex; vertical-align: -0.11ex; " SRC="img54.svg"
 ALT="$\overline{\hbox{INT}}$"></SPAN>.

<P>
<!-- MATH
 $\overline{\hbox{RESET}}$
 -->
<SPAN CLASS="MATH"><IMG STYLE="height: 2.22ex; vertical-align: -0.11ex; " SRC="img52.svg"
 ALT="$\overline{\hbox{RESET}}$"></SPAN> is used to return the CPU to a known state. When
the <!-- MATH
 $\overline{\hbox{RESET}}$
 -->
<SPAN CLASS="MATH"><IMG STYLE="height: 2.22ex; vertical-align: -0.11ex; " SRC="img52.svg"
 ALT="$\overline{\hbox{RESET}}$"></SPAN> line is pulled low, a <!-- MATH
 $\overline{\hbox{RESET}}$
 -->
<SPAN CLASS="MATH"><IMG STYLE="height: 2.22ex; vertical-align: -0.11ex; " SRC="img52.svg"
 ALT="$\overline{\hbox{RESET}}$"></SPAN> is
generated. The CPU then does several things. I, and R are set to $00.
PC is set to $0000. SP becomes $FFFF. A and F are set to $FF.  The
interrupt mode is set to 0. And (maskable) interrupts are disabled by
clearing IFF1 and IFF2.

<P>
<!-- MATH
 $\overline{\hbox{NMI}}$
 -->
<SPAN CLASS="MATH"><IMG STYLE="height: 2.22ex; vertical-align: -0.11ex; " SRC="img53.svg"
 ALT="$\overline{\hbox{NMI}}$"></SPAN> is the non-maskable interrupt. Upon receiving a
non-maskable interrupt (<!-- MATH
 $\overline{\hbox{NMI}}$
 -->
<SPAN CLASS="MATH"><IMG STYLE="height: 2.22ex; vertical-align: -0.11ex; " SRC="img53.svg"
 ALT="$\overline{\hbox{NMI}}$"></SPAN> being pulled low), PC is
pushed on the stack, IFF1 is copied to IFF2, IFF1 is cleared
(inhibiting maskable interrupts). The <!-- MATH
 $\overline{\hbox{NMI}}$
 -->
<SPAN CLASS="MATH"><IMG STYLE="height: 2.22ex; vertical-align: -0.11ex; " SRC="img53.svg"
 ALT="$\overline{\hbox{NMI}}$"></SPAN> should end
with RETN which copies the contents of IFF2 to IFF1 (returning the
interrupt state to what it was before the <!-- MATH
 $\overline{\hbox{NMI}}$
 -->
<SPAN CLASS="MATH"><IMG STYLE="height: 2.22ex; vertical-align: -0.11ex; " SRC="img53.svg"
 ALT="$\overline{\hbox{NMI}}$"></SPAN>) and PF is
popped off the stack.

<P>
The interrupt generally of most interest to programmers is
<!-- MATH
 $\overline{\hbox{INT}}$
 -->
<SPAN CLASS="MATH"><IMG STYLE="height: 2.22ex; vertical-align: -0.11ex; " SRC="img54.svg"
 ALT="$\overline{\hbox{INT}}$"></SPAN>. So much so that if programmers talk about
interrupts on the Z80, they are probebly only talking about
<!-- MATH
 $\overline{\hbox{INT}}$
 -->
<SPAN CLASS="MATH"><IMG STYLE="height: 2.22ex; vertical-align: -0.11ex; " SRC="img54.svg"
 ALT="$\overline{\hbox{INT}}$"></SPAN>. The processing of <!-- MATH
 $\overline{\hbox{INT}}$
 -->
<SPAN CLASS="MATH"><IMG STYLE="height: 2.22ex; vertical-align: -0.11ex; " SRC="img54.svg"
 ALT="$\overline{\hbox{INT}}$"></SPAN> is controlled
by IFF1 and IFF2 which are set using EI to enable interrupts and reset
using DI to disable interrupts. Interrupts can happen at any time and
should preserve register contents.  If none of your code uses the
alternate registers the EXX and EX AF,AF’ instructions can make this
faster and easier. Interrupt routined should end with EI and RETI to
reenable interrupts, potentially inform the interrupting device that
its interrupt has been serviced, and return from the interrupt
routine. In general the Spectrum machines do not make any distingtion
between RET and RETI, but future developments in the ZX Spectrum Next
may make the distinction important.

<P>
IM0 – When an interrupt is received by the CPU it disables interrupts
and executes the instruction placed on the bus by the interrupting
device and (no known use on the Next) It is enabled with the IM0
instruction and enabling interrupts (EI).

<P>
IM1 – When an interrupt is received, the CPU disables interrupts and
jumps to an interrupt handler at $0038 (normally in ROM). The ROM
interrupt handler updates the frame counter and scans the
keyboard. This is the default interrupt handling method for the ZX
Spectrum and is probably the method to use if you don’t need the ROMs
for anything. It is enabled using the IM1 instruction and enabling
interrupts.

<P>
IM2 – When the CPU receives an interrupt it disables interrupts and
jumps to an interrupt routine starting at the contents of the jump
table at I. The start of the interrupt routine is the contents of
I*$100+bus and I*$100+bus+1. Most devices that can supply interrupts
on the ZX Spectrum leave the data bus in a floating state.  As a
result the interpreted state of the data bus while generally $FF is
not entirely predictable.  The solution to place your interrupt
routine at an address where the MSB and LSB are the same ($0101,
$0202, … $FFFF) then place 257 copies of that value in a block
starting at I*$100 (you can set the value of the I register).

<P>
Code:
<PRE>
;; my program
org $8000
;; enable interrupt mode im2
ld i,$fe
im2
ei
;; program body
;; interrupt routine
handler:
;; preserve registers used
;; handle interrupt
;; restore registers
ei
reti
;; jump to interrupt routine
org $fdfd
jp handler
;; im2 jump table
org $fe00 ; not actually legal
defs $101,$fd
</PRE>

<DIV CLASS="navigation"><HR>
<!--Navigation Panel-->
<A
 HREF="node126.html">
<IMG WIDTH="37" HEIGHT="24" ALT="next" SRC="next.png"></A> 
<A
 HREF="zxnext_notes.html">
<IMG WIDTH="26" HEIGHT="24" ALT="up" SRC="up.png"></A> 
<A
 HREF="node124.html">
<IMG WIDTH="63" HEIGHT="24" ALT="previous" SRC="prev.png"></A> 
<A ID="tex2html1078"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALT="contents" SRC="contents.png"></A> 
<A ID="tex2html1080"
  HREF="node193.html">
<IMG WIDTH="43" HEIGHT="24" ALT="index" SRC="index.png"></A> 
<BR>
<B> Next:</B> <A
 HREF="node126.html">Raspberry Pi0 Acceleration</A>
<B> Up:</B> <A
 HREF="zxnext_notes.html">ZX Spectrum Next Programming</A>
<B> Previous:</B> <A
 HREF="node124.html">Summary</A>
 &nbsp; <B>  <A ID="tex2html1079"
  HREF="node1.html">Contents</A></B> 
 &nbsp; <B>  <A ID="tex2html1081"
  HREF="node193.html">Index</A></B> </DIV>
<!--End of Navigation Panel-->

</BODY>
</HTML>
