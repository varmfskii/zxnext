<!DOCTYPE HTML>

<!--Converted with LaTeX2HTML 2019 (Released January 1, 2019) -->
<HTML lang="EN">
<HEAD>
<TITLE>Raspberry Pi0 Acceleration</TITLE>
<META NAME="description" CONTENT="Raspberry Pi0 Acceleration">
<META NAME="keywords" CONTENT="zxnext_notes">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="viewport" CONTENT="width=device-width, initial-scale=1.0">
<META NAME="Generator" CONTENT="LaTeX2HTML v2019">

<LINK REL="STYLESHEET" HREF="zxnext_notes.css">

<LINK REL="next" HREF="node125.html">
<LINK REL="previous" HREF="node123.html">
<LINK REL="next" HREF="node125.html">
</HEAD>

<BODY >

<DIV CLASS="navigation"><!--Navigation Panel-->
<A
 HREF="node125.html">
<IMG WIDTH="37" HEIGHT="24" ALT="next" SRC="next.png"></A> 
<A
 HREF="zxnext_notes.html">
<IMG WIDTH="26" HEIGHT="24" ALT="up" SRC="up.png"></A> 
<A
 HREF="node123.html">
<IMG WIDTH="63" HEIGHT="24" ALT="previous" SRC="prev.png"></A> 
<A ID="tex2html1054"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALT="contents" SRC="contents.png"></A> 
<A ID="tex2html1056"
  HREF="node184.html">
<IMG WIDTH="43" HEIGHT="24" ALT="index" SRC="index.png"></A> 
<BR>
<B> Next:</B> <A
 HREF="node125.html">System Software</A>
<B> Up:</B> <A
 HREF="zxnext_notes.html">ZX Spectrum Next Programming</A>
<B> Previous:</B> <A
 HREF="node123.html">Interrupts</A>
 &nbsp; <B>  <A ID="tex2html1055"
  HREF="node1.html">Contents</A></B> 
 &nbsp; <B>  <A ID="tex2html1057"
  HREF="node184.html">Index</A></B> 
<BR>
<BR></DIV>
<!--End of Navigation Panel-->

<H1><A ID="SECTION00900000000000000000">
Raspberry Pi0 Acceleration</A>
</H1>
The Spectrum Next has a header (with male pins) which can be attached
to a Raspberry Pi Zero. There is a modified version of DietPi called
NextPi which is the standard distro for the Raspberry Pi0
accelerator. Software for the general public should be written
assuming that it will be interfacing with a Pi0 running this distro.

<P>
If you are more adventurous, you may choose to use another distro, or
even another accelerator that uses the Raspberry Pi style (40 pin)
expansion bus.  Chief concers when doing this is that you have a
console presented on the UART that defaults to 115,200 bps, you don't
need to login, the machine is configured with a driver to treat the
<SPAN CLASS="MATH"><IMG STYLE="height: 2.14ex; vertical-align: -0.11ex; " SRC="img53.svg"
 ALT="$I^2S$"></SPAN> interface as a sound card, and the presence of the nextpi
scripts.

<P>
The Raspberry Pi 0 has a Broadcom BCM2835 SoC with an ARMv6 core, a
Videocore 4 GPU, and its own 512 MB memory and HDMI output. It has its
own SD card from which it boots. For this application the Pi 0 ships
with a 1GB microSD card containing NextPi a customized version of
DietPi.

<P>
The Pi Zero, if installed, is a smart peripheral for the ZX Spectrum
Next. Available interfaces are: low level access to the GPIO pins,
higher level access to standardized I/O interfaces, and use of the Pi
Zero as a sound card.

<P>
When using the low level GPIO interface Pi Zero GPIO pins 2-27 can be
configured as either inputs or outputs using nextregs $90-$93. If
they are outputs, the output state can be set by writing to nextregs
$98-$9b. The current status of the GPIO pins can be read from
nextregs $98-$9b whether it is the state driven by the ZX Spectrum
Next or the state drive by some other peripherial attached to the bus
(normally the Raspberry Pi Zero).

<P>
Standardized I/O access with the Pi Zero can use the <SPAN CLASS="MATH"><IMG STYLE="height: 2.14ex; vertical-align: -0.11ex; " SRC="img54.svg"
 ALT="$I^2C$"></SPAN>, SPI, or
UART interfaces and is configured using nextreg $a0. Any enabled port
will disable low level (write) access to the corresponding GPIO
pins.

<P>
The <SPAN CLASS="MATH"><IMG STYLE="height: 2.14ex; vertical-align: -0.11ex; " SRC="img54.svg"
 ALT="$I^2C$"></SPAN> interface is controlled using ports $103b (SCL) and $113b
(SDA). This is the same <SPAN CLASS="MATH"><IMG STYLE="height: 2.14ex; vertical-align: -0.11ex; " SRC="img54.svg"
 ALT="$I^2C$"></SPAN> interface that is used for the optional
Real Time Clock. Interfacing with the Pi Zero over <SPAN CLASS="MATH"><IMG STYLE="height: 2.14ex; vertical-align: -0.11ex; " SRC="img54.svg"
 ALT="$I^2C$"></SPAN> is
complicated by the fact that it is a master/slave interface, but both
the ZX Spectrum Next and Pi Zero are configured to be bus masters.

<P>
The SPI interface is controlled using ports $e7 (/CS) and $eb
(/DATA). The SPI interface is shared between the SD card(s), the flash
memory, and the Pi Zero. Interfacing with the Pi Zero over SPI is
complicated by the fact it is a master/slave interface and both the ZX
Spectrum Next and Pi Zero are configured to be bus masters.

<P>
The UART interface is controlled by ports $133b (TX), $143b (RX),
and $153b (control). This is the default means of bidirectional
communication between the ZX Spectrum Next and Pi Zero. To use the
UART you must first enable the UART on the GPIO and connecting it to
the Pi Zero (not hats) by setting nextreg $a0 bits 5 and 4 to 1 and
selecting Pi for the UART by setting port $153b bit 6 to 1. Assuming
that the serial parameters match (by default both ends are set to
115,200 bps with 8N1 and no flow control) this will give you access to
the serial console on the Pi Zero over the UART.

<P>
<PRE>
;; enable UART connection with Pi Zero
   ld c,$3b
   ld b,$15 ; UART control
;; select Pi on UART control
   in a,(c)
   or $40
   out (c),a
   ld b,$24 ; Next Register Select
   ld a,$a0
   out (c),a
   inc b ; Next Register Data
;; Enable UART on GPIO and select Pi
   in a,(c)
   or $30
   out (c),a
</PRE>

<P>
The <SPAN CLASS="MATH"><IMG STYLE="height: 2.14ex; vertical-align: -0.11ex; " SRC="img53.svg"
 ALT="$I^2S$"></SPAN> sound interface between the ZX Spectrum Next and the Pi Zero
is controlled by nextregs $a2 and $a3. Normally, one would control
the Pi through some other channel such as the UART recieve audio from
the Pi to either use as a fulloy programmable sound card or to allow
loading of tape files on the ZX Spectrum Next.

<P>
(R/W) $90 (144) <SPAN CLASS="MATH"><IMG STYLE="height: 1.06ex; vertical-align: -0.11ex; " SRC="img7.svg"
 ALT="$\Rightarrow$"></SPAN> PI GPIO Output Enable 0
<table width="90%">
bit 7 = Pi GPIO 7
bit 6 = Pi GPIO 6
bit 5 = Pi GPIO 5
bit 4 = Pi GPIO 4
bit 3 = Pi GPIO 3
bit 2 = Pi GPIO 2
bit 1 = Pi GPIO 1 (cannot be enabled)
bit 0 = Pi GPIO 0 (cannot be enabled)<tr><td valign="top">&nbsp;$00 on soft reset
</td></tr></table>

<P>
(R/W) $91 (145) <SPAN CLASS="MATH"><IMG STYLE="height: 1.06ex; vertical-align: -0.11ex; " SRC="img7.svg"
 ALT="$\Rightarrow$"></SPAN> PI GPIO Output Enable 1
<table width="90%">
bit 7 = Pi GPIO 15
bit 6 = Pi GPIO 14
bit 5 = Pi GPIO 13
bit 4 = Pi GPIO 12
bit 3 = Pi GPIO 11
bit 2 = Pi GPIO 10
bit 1 = Pi GPIO 9
bit 0 = Pi GPIO 8<tr><td valign="top">&nbsp;$00 on soft reset
</td></tr></table>

<P>
(R/W) $92 (146) <SPAN CLASS="MATH"><IMG STYLE="height: 1.06ex; vertical-align: -0.11ex; " SRC="img7.svg"
 ALT="$\Rightarrow$"></SPAN> PI GPIO Output Enable 2
<table width="90%">
bit 7 = Pi GPIO 23
bit 6 = Pi GPIO 22
bit 5 = Pi GPIO 21
bit 4 = Pi GPIO 20
bit 3 = Pi GPIO 19
bit 2 = Pi GPIO 18
bit 1 = Pi GPIO 17
bit 0 = Pi GPIO 16<tr><td valign="top">&nbsp;$00 on soft reset
</td></tr></table>

<P>
(R/W) $93 (147) <SPAN CLASS="MATH"><IMG STYLE="height: 1.06ex; vertical-align: -0.11ex; " SRC="img7.svg"
 ALT="$\Rightarrow$"></SPAN> PI GPIO Output Enable 3
<table width="90%">
bits 7-4 = Reserved, must be 0
bit 3 = Pi GPIO 27
bit 2 = Pi GPIO 26
bit 1 = Pi GPIO 25
bit 0 = Pi GPIO 24<tr><td valign="top">&nbsp;$00 on soft reset
</td></tr></table>

<P>
(R/W) $98 (152) <SPAN CLASS="MATH"><IMG STYLE="height: 1.06ex; vertical-align: -0.11ex; " SRC="img7.svg"
 ALT="$\Rightarrow$"></SPAN> PI GPIO 0
<table width="90%">
bit 7 = Pi GPIO 7
bit 6 = Pi GPIO 6
bit 5 = Pi GPIO 5
bit 4 = Pi GPIO 4
bit 3 = Pi GPIO 3
bit 2 = Pi GPIO 2
bit 1 = Pi GPIO 1 (read only)
bit 0 = Pi GPIO 0 (read only)<tr><td valign="top">&nbsp;$ff on soft reset
</td></tr></table>

<P>
(R/W) $99 (153) <SPAN CLASS="MATH"><IMG STYLE="height: 1.06ex; vertical-align: -0.11ex; " SRC="img7.svg"
 ALT="$\Rightarrow$"></SPAN> PI GPIO 1
<table width="90%">
bit 7 = Pi GPIO 15
bit 6 = Pi GPIO 14
bit 5 = Pi GPIO 13
bit 4 = Pi GPIO 12
bit 3 = Pi GPIO 11
bit 2 = Pi GPIO 10
bit 1 = Pi GPIO 9
bit 0 = Pi GPIO 8<tr><td valign="top">&nbsp;$01 on soft reset
</td></tr></table>

<P>
(R/W) $9A (154) <SPAN CLASS="MATH"><IMG STYLE="height: 1.06ex; vertical-align: -0.11ex; " SRC="img7.svg"
 ALT="$\Rightarrow$"></SPAN> PI GPIO 2
<table width="90%">
bit 7 = Pi GPIO 23
bit 6 = Pi GPIO 22
bit 5 = Pi GPIO 21
bit 4 = Pi GPIO 20
bit 3 = Pi GPIO 19
bit 2 = Pi GPIO 18
bit 1 = Pi GPIO 17
bit 0 = Pi GPIO 16<tr><td valign="top">&nbsp;$00 on soft reset
</td></tr></table>

<P>
(R/W) $9B (155) <SPAN CLASS="MATH"><IMG STYLE="height: 1.06ex; vertical-align: -0.11ex; " SRC="img7.svg"
 ALT="$\Rightarrow$"></SPAN> PI GPIO 3
<table width="90%">
bits 7-4 = Reserved, must be 0
bit 3 = Pi GPIO 27
bit 2 = Pi GPIO 26
bit 1 = Pi GPIO 25
bit 0 = Pi GPIO 24<tr><td valign="top">&nbsp;$00 on soft reset
</td></tr></table>

<P>
(R/W) $A0 (160) <SPAN CLASS="MATH"><IMG STYLE="height: 1.06ex; vertical-align: -0.11ex; " SRC="img7.svg"
 ALT="$\Rightarrow$"></SPAN> PI Peripheral Enable

<UL>
<LI>bits 7-6 = Reserved, must be 0
</LI>
<LI>bit 5 = Enable UART on GPIO 14,15 (overrides gpio) (soft reset
  = 0)
</LI>
<LI>bit 4 = 0 to connect Rx to GPIO 15, Tx to GPIO 14 (for comm
  with pi hats) (soft reset = 0) = 1 to connect Rx to GPIO 14, Tx to
  GPIO 15 (for comm with pi)
</LI>
<LI>bit 3 = Enable <SPAN CLASS="MATH"><IMG STYLE="height: 2.14ex; vertical-align: -0.11ex; " SRC="img54.svg"
 ALT="$I^2C$"></SPAN> on GPIO 2,3 (override gpio) (soft reset =
  0)
</LI>
<LI>bits 2-1 = Reserved, must be 0
</LI>
<LI>bit 0 = Enable SPI on GPIO 7,8,9,10,11 (overrides gpio) (soft
  reset = 0)
</LI>
</UL>

<P>
(R/W) $A2 (162) <SPAN CLASS="MATH"><IMG STYLE="height: 1.06ex; vertical-align: -0.11ex; " SRC="img7.svg"
 ALT="$\Rightarrow$"></SPAN> PI <SPAN CLASS="MATH"><IMG STYLE="height: 2.14ex; vertical-align: -0.11ex; " SRC="img53.svg"
 ALT="$I^2S$"></SPAN> Audio Control

<UL>
<LI>bits 7-6 = <SPAN CLASS="MATH"><IMG STYLE="height: 2.14ex; vertical-align: -0.11ex; " SRC="img53.svg"
 ALT="$I^2S$"></SPAN> enable (soft reset = 00)
  
<UL>
<LI>00 = <SPAN CLASS="MATH"><IMG STYLE="height: 2.14ex; vertical-align: -0.11ex; " SRC="img53.svg"
 ALT="$I^2S$"></SPAN> off
</LI>
<LI>01 = <SPAN CLASS="MATH"><IMG STYLE="height: 2.14ex; vertical-align: -0.11ex; " SRC="img53.svg"
 ALT="$I^2S$"></SPAN> is mono source right
</LI>
<LI>10 = <SPAN CLASS="MATH"><IMG STYLE="height: 2.14ex; vertical-align: -0.11ex; " SRC="img53.svg"
 ALT="$I^2S$"></SPAN> is mono source left
</LI>
<LI>11 = <SPAN CLASS="MATH"><IMG STYLE="height: 2.14ex; vertical-align: -0.11ex; " SRC="img53.svg"
 ALT="$I^2S$"></SPAN> is stereo
  
</LI>
</UL>
</LI>
<LI>bit 5 = Reserved, must be 0
</LI>
<LI>bit 4 = 0 PCM_DOUT to pi, PCM_DIN from pi (hats) (soft reset
  = 0) = 1 PCM_DOUT from pi, PCM_DIN to pi (pi)
</LI>
<LI>bit 3 = Mute left side (soft reset = 0)
</LI>
<LI>bit 2 = Mute right side (soft reset = 0)
</LI>
<LI>bit 1 = Slave mode (PCM_CLK, PCM_FS supplied externally)
  (soft reset = 0)
</LI>
<LI>bit 0 = Direct <SPAN CLASS="MATH"><IMG STYLE="height: 2.14ex; vertical-align: -0.11ex; " SRC="img53.svg"
 ALT="$I^2S$"></SPAN> audio to EAR on port $FE (soft reset = 0)
</LI>
</UL>

<P>
(R/W) $A3 (163) <SPAN CLASS="MATH"><IMG STYLE="height: 1.06ex; vertical-align: -0.11ex; " SRC="img7.svg"
 ALT="$\Rightarrow$"></SPAN> PI <SPAN CLASS="MATH"><IMG STYLE="height: 2.14ex; vertical-align: -0.11ex; " SRC="img53.svg"
 ALT="$I^2S$"></SPAN> Clock Divide (Master Mode)
<table width="90%">
bits 7-0 = Clock divide sets sample rate when in master mode
  (soft reset = 11)<tr><td valign="top">&nbsp;clock divider = 538461 / SampleRateHz - 1
</td></tr></table>


<DIV CLASS="navigation"><HR>
<!--Navigation Panel-->
<A
 HREF="node125.html">
<IMG WIDTH="37" HEIGHT="24" ALT="next" SRC="next.png"></A> 
<A
 HREF="zxnext_notes.html">
<IMG WIDTH="26" HEIGHT="24" ALT="up" SRC="up.png"></A> 
<A
 HREF="node123.html">
<IMG WIDTH="63" HEIGHT="24" ALT="previous" SRC="prev.png"></A> 
<A ID="tex2html1054"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALT="contents" SRC="contents.png"></A> 
<A ID="tex2html1056"
  HREF="node184.html">
<IMG WIDTH="43" HEIGHT="24" ALT="index" SRC="index.png"></A> 
<BR>
<B> Next:</B> <A
 HREF="node125.html">System Software</A>
<B> Up:</B> <A
 HREF="zxnext_notes.html">ZX Spectrum Next Programming</A>
<B> Previous:</B> <A
 HREF="node123.html">Interrupts</A>
 &nbsp; <B>  <A ID="tex2html1055"
  HREF="node1.html">Contents</A></B> 
 &nbsp; <B>  <A ID="tex2html1057"
  HREF="node184.html">Index</A></B> </DIV>
<!--End of Navigation Panel-->

</BODY>
</HTML>
