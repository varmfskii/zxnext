\section {Memory}
A ZX Spectrum Next will typically have either 1MB or 2MB memory. There
are two different types of memory, BRAM and SRAM. BRAM exists on the
FPGA and SRAM is the normal memory outside the FPGA. At startup files
are read off the SD card to fill what would normally be considered to
be ROM. There are a number of different ways to control memory on the
ZX Spectrum Next.  ZX Next native, ZX Spectrum 128 with the +3
extensions, divMMC, and Multiface.

\section{Default Layout}
The default mapping of memory banks is the same as on 128k Spectrum
models with a ROM mapped in at \$0000-\$3FFF, bank 5 at \$4000-\$7FFF,
bank 2 at \$8000-\$BFFF, and bank 0 at \$C000-\$FFFF.

\section{RAM}

\subsection{ZX Spectrum Next Native}
Registers \$50 to \$57 control the which SRAM pages are in each of the
eight memory slots.  Registers \$50 and \$51 support the special value
\$FF which indicates that the currently selected ROM is to be mapped
into slots 0 and/or 1 (\$0000-\$3FFF).

\input{registers/tbblue/50.tex}
\input{registers/tbblue/51.tex}
\input{registers/tbblue/52.tex}
\input{registers/tbblue/53.tex}
\input{registers/tbblue/54.tex}
\input{registers/tbblue/55.tex}
\input{registers/tbblue/56.tex}
\input{registers/tbblue/57.tex}

In addition the ZX Next has special controls which allow the data area
for Layer 2 to be overlaied on memory in a fashion that permits
selective read or write access. For details see the section on Layer 2
video.

\subsection{ZX Spectrum 128}
In addition to the native memory management, the ZX Next supports a
memory management system that is an expanded, and backward compatible,
version of the the system used on earlier ZX Spectrum models. This
system uses registers \$1FFF, \$7FFD, and \$DFFD.

\paragraph{Spectrum 128 Standard Paging}

128-style memory management can only alter the bank addressed at
\$c000 (16k-slot 4, or 8k-slots 7-8). The active 16k-bank at \$c000 is
selected by writing the 3 LSBs of the 16k-bank number to the bottom 3
bits of Memory Paging Control (\$7FFD), and the 4 MSBs to the bottom 4
bits of Next Memory Bank Select (\$DFFD). (The reason for the division
is that the original Spectrum 128, having only 128k of memory, only
needed 3 bits.)

If you are using the standard interrupt handler or OS routines, then
any time you write to Memory Paging Control (\$7FFD) you should also
store the value at \$5B5C. Any time you write to Plus 3 Memory Paging
Control (\$1FFD) you should also store the value at \$5B67. There is
no corresponding system variable for the Next-only Next Memory Bank
Select (\$DFFD) and standard OS routines may not support the extended
banks properly.

\paragraph{Paging out ROM}

ROM can be paged out by enabling AllRam mode, or by using Next memory
management. Beware that some programs may assume that they can find
ROM service routines at fixed addresses between \$0000-\$3fff. More
importantly, if the default interrupt mode (IM 1) is set, the Z80 will
jump the program counter to \$0038 every frame expecting to find an
interrupt handler there. If it does not, pain and suffering will
likely result. DI is your friend. On the plus side, this does allow
you to write your own interrupt handler without the nuisance of using
IM 2.

\paragraph{Spectrum 128 Special Paging}

``Special paging mode'' (also called ``AllRam mode'' or ``CP/M mode'')
is enabled by writing a value with the LSB set to Plus 3 Memory Paging
Control (\$1FFD). Depending on the 3 low bits of this value a memory
configuration is selected as follows:

\begin{table}[h]\centering
  \caption{Special Paging Modes}
  \csvautotabular{memory/zx128mm.csv}
\end{table}

\section{ROM}

\subsection{ZX Next native}

\subsection{ZX Spectrum 128k}

\paragraph{ROM paging and selection}

\$0000-\$3fff is usually mapped to ROM. This area can only be fully
remapped using Next memory management. ROM is not considered one of
the numbered banks; it is mapped to the two 8k-banks by default, or by
setting their 8k-bank numbers to 255.

The 128k Spectrum has 2 ROM pages. Which of these is mapped is
selected by altering Bit 4 of Memory Paging Control (\$7FFD). The
+2a/+3 has 4 ROM pages; the extra bit needed to select between these
is bit 2 of Plus 3 Memory Paging Control (\$1FFD). This maintains
compatibility with the original machines' ROM paging as long as the
ROM is not paged out.

\input{ports/1FFD.tex}
\input{ports/7FFD.tex}
\input{ports/DFFD.tex}

\subsection{Multiface}

9f 1-In, 128-In2\\
1f 1-Out\\
bf 128-In, 3-Out\\
3f 128-Out, 3-In, 3-button\\
7f3f 3-7ffd\\
1f3f 3-1ffd

\subsection{divMMC}

\input{ports/E3.tex}

\section{Interactions between paging methods}

Changes made in 128 style and Next style memory management are
synchronized. The most recent change always has priority. This means
that

using 128-style memory management to select a new 16k-bank in 16k-slot
4 will update the MMU registers for the two 8k-slots with the
corresponding 8k-bank numbers.  enabling AllRam mode will update all
of the 8k-bank values with the appropriate 8k-slot numbers. These may
then be overwritten using Next memory management without needing to
alter the value at port \$1FFD.  Since the 128-style memory management
ports are not readable, there is no synchronization applicable in the
other direction.
