\chapter{Video}

ZX Spectrum Next video splits the display types into four categories
(ULA, tilemap, layer 2, and sprites) which have their own sets of
controls for colour palettes, clipping, and scrolling. Some aspects of
ULA and tilemap are tied together, but all the rest operate in a
largely independent manner using a layering system. The ULA category
has a number of separate video modes that it can use. One of these
(LoRes) is incompatible with using tilemaps.

\section{Video Layering and Transparency}
Video is rendered as three layers which are referred to as ULA (which
includes the tilemap), layer 2, and sprites.  The ordering of the
layers is controlled by Next port \$15 (21) bits 4-2:

\begin{table}[h]\centering
  \caption{Video Layering}
  \csvautotabular{video/videolayering.csv}
\end{table}

\index{transparency}
Transparency for Layer 2, ULA, and LoRes are controlled by Next
register \$14 (20) and defaults to \$E3. This colour ignores the state
of the least significant blue bit, so \$E3 equates to both \$1C6 and
\$1C7. For Sprites and Tilemaps transparency is determined by colour
index. For Sprites this is controlled by register \$4B (with only the
least significant 4-bits being relevant for 16-colour Sprites). For
Tilemaps, the transparency index is set by register \$4C. If all
layers are transparent, the transparency fallback colour is
displayed. This is set by register \$4A.

(R/W) \$4A (74) $\Rightarrow$ Transparency colour fallback
\begin{itemize}
\item[] bits 7-0 = Set the 8 bit colour used if all layers are transparent.
\end{itemize}
(black on reset = 0)

\section{Palette}
\index{palette}
Each video mode group has a pair of palettes assigned to it a primary
and an alternate palette.

(R/W) \$43 (67) $\Rightarrow$ Palette Control
\begin{itemize}
\item[] bit 7 = '1' to disable palette write auto-increment.
\item[] bits 6-4 = Select palette for reading or writing:
  \begin{itemize}
  \item[] 000 = ULA first palette
  \item[] 100 = ULA second palette
  \item[] 001 = Layer 2 first palette
  \item[] 101 = Layer 2 second palette
  \item[] 010 = Sprites first palette
  \item[] 110 = Sprites second palette
  \item[] 011 = Tilemap first palette
  \item[] 111 = Tilemap second palette
  \end{itemize}
\item[] bit 3 = Select Sprites palette (0 = first palette, 1 = second palette)
\item[] bit 2 = Select Layer 2 palette (0 = first palette, 1 = second palette)
\item[] bit 1 = Select ULA palette (0 = first palette, 1 = second palette)
\item[] bit 0 = Enable ULANext mode if 1. (0 after a reset)
\end{itemize}

(R/W) \$40 (64) $\Rightarrow$ Palette Index
\begin{itemize}
\item[] bits 7-0 = Select the palette index to change the associated colour.
\end{itemize}
For the ULA only, INKs are mapped to indices 0-7, Bright INKS to
indices 8-15, PAPERs to indices 16-23 and Bright PAPERs to indices
24-31.\\
In ULANext mode, INKs come from a subset of indices 0-127 and PAPERs
come from a subset of indices 128-255. The number of active indices
depends on the number of attribute bits assigned to INK and PAPER out
of the attribute byte.  The ULA always takes border colour from paper.

(R/W) \$41 (65) $\Rightarrow$ Palette Value (8 bit colour)
\begin{itemize}
\item[] bits 7-0 = Colour for the palette index selected by the register \$40.
\end{itemize}
(Format is RRRGGGBB - the lower blue bit of the 9-bit colour will be a
logical OR of blue bits 1 and 0 of this 8-bit value.)\\
After the write, the palette index is auto-incremented to the next
index if the auto-increment is enabled at reg \$43. Reads do not
auto-increment.

(R/W) \$44 (68) $\Rightarrow$ Palette Value (9 bit colour)\\
Two consecutive writes are needed to write the 9 bit colour
\begin{itemize}
\item[] 1st write:
  \begin{itemize}
  \item[] bits 7-0 = RRRGGGBB
  \end{itemize}
\item[] 2nd write.
  If writing a L2 palette\\
  \begin{itemize}
  \item[] bit 7 = 1 for L2 priority colour, 0 for normal\\
    Priority colour will always be on top even on an SLU priority
    arrangement. If you need the exact same colour on priority and non
    priority locations you will need to program the same colour twice
    changing bit 7 to 0 for the second colour
  \item[] bits 6-1 = Reserved, must be 0
  \item[] bit 0 = lsb B
  \end{itemize}
  If writing another palette
  \begin{itemize}
  \item[] bits 7-1 = Reserved, must be 0
  \item[] bit 0 = lsb B
  \end{itemize}
\end{itemize}
After the two consecutive writes the palette index is
auto-incremented if the auto-increment is enabled by reg \$43.\\
Reads only return the 2nd byte and do not auto-increment.

\section{ULA group}
The ULA layer supports ZX Spectrum video, Timex video modes, and the
Spectrum Nextâ€™s lores video mode all use 16k memory bank 5 or 7 with
the data coming from some combination of addresses \$0000-\$17FF
(bitmap 1), \$1800-\$1AFF (attribute 1), \$2000-\$37FF (bitmap 2), and
\$3800-\$3AFF (attribute 2) within the selected bank.  Assuming
default memory mapping and the use of bank 5 this will be mapped as
some combination of memory \$4000-\$57FF, \$5800-\$5AFF,
\$6000-\$77FF, \$780-\$7AFF. All of the modes other than the lores
mode can either use the default ZX Spectrum colours, or ULANext mode
which uses a 256 entry palette to determine the colour. In the
Spectrum and Timex modes all colours are either Paper (foreground),
paper (background), or border colours.

\subsection{Colour Attributes}
The ZX Spectrum Next has two major modes for colour attributes
allowing a total of nine ways to map the palette to the original ZX
Spectrum attributes. One with flashing enabled and eight with flashing
disabled. This mapping is controlled by Next registers \$42 (66,
palette format) and \$43 (67, palette control).  Palette control
switches between flashing enabled (0, default) and flashing disabled
(1)

\begin{table}[h]\centering
  \caption{Flashing Enabled}
  \csvautotabular{video/flash.csv}
\end{table}

Flashing Enabled is similar to the original Spectrum colour
attributes. INKs are mapped to indices 0-7, Bright INKS to indices
8-15, PAPERs to indices 16-23 and Bright PAPERs to indices 24-31.

The ULA next modes use a varying number of bits from the attribute
byte to determine the ink colour as the palette index from the
appropriate bits (all others being zero) and the paper colours coming
from the indicated value+128 with palette format 255 being a special
case where all the bits determine the ink colour while the paper is
always palette index 128. The ULA always takes border colour from paper.

\begin{table}[h]\centering
  \caption{ULA Next}
  \csvautotabular{video/palfmt.csv}
\end{table}

\subsection{ZX Spectrum Mode}

Timex mode 0

This is the default ULA mode and has its origins in the original ZX
Spectrum. It uses $256\times192$ pixels with $8\times8$ colour
attribute areas mapped into a $32\times24$ grid. If Timex modes are
not enabled, this and the LoRes mode are the only ones available, so
you would switch back to this mode by writing 000xxxxx to Next
register \$15 (21, the sprites and layers register). If another Timex
mode is enabled, then this is mode 0 so you would write 0 to port \$ff
to enable it. This is a $256\times192$ video mode. The bitmap 1 area
is used for selection between ink and paper colours with one bit per
pixel and the attribute 1 area for colour attributes.

The easiest way to visualize the mapping of this mode is to think of
the $256\times192$ area as being divided into a $32\times24$ grid of
$8\times8$ characters.  IF we consider X and Y as the position in the
grid and R to the the row within the character.  For ink/paper
selection, 0=paper, 1=ink and the entries are stored left to right as
lsb to msb within the bye.  The address for a pixel value is:
$0R_4R_3Y_2Y_1Y_0R_2R_1R_0C_4C_3C_2C_1C_0$. Each $8\times8$ cell has
its own colour attribute where the address for an attribute cell is
$0110R_4R_3R_2R_1R_0C_4C_3C_2C_1C_0$ in other words mapped lineally
column-wise starting at the beginning of the attribute 1 area.

Code:
\begin{verbatim}
  ;; from any other Timex mode:
  ld a,$00
  ld c,$ff
  out (c),a

  ;; from LoRes mode:
  ld bc,$243B ; next register select port
  ld a,$15
  out (c),a
  ld bc,$253B ; next register r/w port
  in a,(c)
  and $7f
  out (c),a
\end{verbatim}

\subsection{Alternate Page Mode}

Timex mode 1

This mode is the same as ZX Spectrum mode at alternate
addresses. Alternate page mode is selected by enabling Timex modes by
writing 00xxxx1xx to Next register \$08 (8, Peripheral 3 setting) then
writing 1 to the Timex ULA port (\$ff).  It is identical to ZX
Spectrum mode except the pixel are mapped to the bitmap 2 area giving
use pixel addresses of $1R_4R_3Y_2Y_1Y_0R_2R_1R_0C_4C_3C_2C_1C_0$ and
the attributes to the attribute 2 area with addresses of
$1110R_4R_3R_2R_1R_0C_4C_3C_2C_1C_0$.

Code:

\begin{verbatim}
;; disable LoRes mode:
ld bc,$243B ; next register select port
ld a,$15
out (c),a
ld bc,$253B ; next register r/w port
in a,(c)
and $7f
out (c),a
;; set Timex mode
ld bc,$243B ; next register select port
ld a,$08
out (c),a
ld bc,$253B ; next register r/w port
in a,(c)
or $04
out (c),a
;; set alternate page mode
ld c,$ff
ld a,$01
out (c),a
\end{verbatim}

\subsection{Timex Hi-Colour Mode}

Timex mode 2

This mode is a $256\times192$ video mode with $8\times1$ colour
attribute mapping on a $32\times192$ grid. It is selected by writing 2
to the Timex ULA port (\$ff).  Pixel mapping in this mode is the same
as in ZX Spectrum mode using the bitmap 1 area based on
$0R_4R_3Y_2Y_1Y_0R_2R_1R_0C_4C_3C_2C_1C_0$.  The colour attributes use
the bitmap 2 area with $8\times1$ colour attribute areas corresponding
to the addresses $1R_4R_3Y_2Y_1Y_0R_2R_1R_0C_4C_3C_2C_1C_0$.

Code:
\begin{verbatim}
;; disable LoRes mode:
ld bc,$243B ; next register select port
ld a,$15
out (c),a
ld bc,$253B ; next register r/w port
in a,(c)
and $7f
out (c),a
;; set Timex mode
ld bc,$243B ; next register select port
ld a,$08
out (c),a
ld bc,$253B ; next register r/w port
in a,(c)
or $04
out (c),a
;; set hi-colour mode
ld c,$ff
ld a,$02
out (c),a
\end{verbatim}

\subsection{Timex Hi-Resolution Mode}

Timex mode 6

This is a monochrome $512\times192$ video mode. It is selected by
writing to the Timex ULA port (\$ff with values that also select which
two colours (or colour entries in ULANext mode) you use.

\begin{table}[h]\centering
  \caption{Hi-Resolution Colours}
  \csvautotabular{video/hires.csv}
\end{table}
  
Pixels are mapped into both the bitmap 1 and bitmap 2 areas where
8-pixel wide character columns alternate between the two bitmap areas.
The pixels within a byte being rendered left to right lsb to msb as in
other Spectrum video modes.  The addresses for each row within a
character are based on a $64\times32$ grid of $8\times8$ characters
which using a $64\times24$ R, C, and Y scheme gives us addresses of
the form $C_0R_4R_3Y_2Y_1Y_0R_2R_1R_0C_5C_4C_3C_2C_1$.

Code:
\begin{verbatim}
;; disable LoRes mode:
ld bc,$243B ; next register select port
ld a,$15
out (c),a
ld bc,$253B ; next register r/w port
in a,(c)
and $7f
out (c),a
;; set Timex mode
ld bc,$243B ; next register select port
ld a,$08
out (c),a
ld bc,$253B ; next register r/w port
in a,(c)
or $04
out (c),a
;; set hi-res mode, black on white
ld c,$ff
ld a,$06
out (c),a
\end{verbatim}

\subsection{Lo-Resolution Mode}

This is a Spectrum Next specific video mode with a resolution of
$128\times96$ replacing the old Radistan mode.  It allows for
independent selection from the 256 entries in the ULA palette on a
pixel by pixel basis. The pixel data is mapped into the bitmap 1 and
bitmap 2 areas.  It is selected by writing $100xxxxx$ to Next register
\$15 (21, the sprites and layers register).  Each byte corresponds to
a ULA palette entry and bytes are mapped linearly in a row-wise
fashion.

Code:
\begin{verbatim}
;; enable LoRes mode:
ld bc,$243B ; next register select port
ld a,$15
out (c),a
ld bc,$253B ; next register r/w port
in a,(c)
or $80
out (c),a
\end{verbatim}

\subsection{Programming}

(R/W) \$15 (21) $\Rightarrow$ Sprite and Layers system
\begin{itemize}
\item[] bit 7 = LoRes mode, 128 x 96 x 256 colours (1 = enabled)
\item[] bit 6 = Sprite priority (1 = sprite 0 on top, 0 = sprite 127 on top)
\item[] bit 5 = Enable sprite clipping in over border mode (1 = enabled)
\item[] bits 4-2 = set layers priorities:\\
  Reset default is 000, sprites over the Layer 2, over the ULA graphics
  \begin{itemize}
  \item[] 000 - S L U
  \item[] 001 - L S U
  \item[] 010 - S U L
  \item[] 011 - L U S
  \item[] 100 - U S L
  \item[] 101 - U L S
  \item[] 110 - S(U+L) ULA and Layer 2 combined, colours clamped to 7
  \item[] 111 - S(U+L-5) ULA and Layer 2 combined, colours clamped to [0,7]
  \end{itemize}
\item[] bit 1 = Over border (1 = yes)(Back to 0 after a reset)
\item[] bit 0 = Sprites visible (1 = visible)(Back to 0 after a reset)
\end{itemize}

Port \$ff (255) Timex Sinclair/floating bus\\
Disable with bit 2 to Nextreg \$08
\begin{itemize}
\item[] bit 7: memory paging (not on Next)
\item[] bit 6: disables generation of interrupts
\item[] bits 3-5: set hi-res mode colour combination
\item[] bits 0-2: screen mode
  \begin{itemize}
  \item[] 000=normal ULA mode
  \item[] 001=alternate ULA address
  \item[] 010=hi-colour
  \item[] 110=hi-res
  \end{itemize}
\end{itemize}

For information on controlling the palette see the Palette section.

\index{transparency}
(R/W) \$14 (20) $\Rightarrow$ Global transparency color
\begin{itemize}
\item[] bits 7-0 = Transparency color value (\$E3 after a reset)
\end{itemize}
(Note: this value is 8-bit, so the transparency is compared against
only by the MSB bits of the final 9-bit colour)\\
(Note2: this only affects Layer 2, ULA and LoRes. Sprites use register
\$4B for transparency and tilemap uses nextreg \$4C)

\index{clip window}
(R/W) \$1A (26) $\Rightarrow$ Clip Window ULA/LoRes
\begin{itemize}
\item[] bits 7-0 = Coord. of the clip window
  \begin{itemize}
  \item[] 1st write = X1 position
  \item[] 2nd write = X2 position
  \item[] 3rd write = Y1 position
  \item[] 4rd write = Y2 position
  \end{itemize}
\end{itemize}
The values are 0,255,0,191 after a Reset\\
Reads do not advance the clip position

(W) \$1C (28) $\Rightarrow$ Clip Window control
\begin{itemize}
\item[] bits 7-4 = Reserved, must be 0
\item[] bit 3 - reset the tilemap clip index
\item[] bit 2 - reset the ULA/LoRes clip index.
\item[] bit 1 - reset the sprite clip index.
\item[] bit 0 - reset the Layer 2 clip index.
\end{itemize}

(R) \$1C (28) $\Rightarrow$ Clip Window control\\
(may change)
\begin{itemize}
\item[] bits 7-6 = Tilemap clip index
\item[] bits 5-4 = Layer 2 clip index
\item[] bits 3-2 = Sprite clip index
\item[] bits 1-0 = ULA clip index
\end{itemize}

\index{scroll offset}
(R/W) \$32 (50) $\Rightarrow$ ULA / LoRes Offset X
\begin{itemize}
\item[] bits 7-0 = X Offset (0-255)(Reset to 0 after a reset)
\end{itemize}
ULA can only scroll in multiples of 8 pixels so the lowest 3 bits have
no effect at this time.\\
LoRes scrolls in "half-pixels" at the same resolution and smoothness
as Layer 2.

(R/W) \$33 (51) $\Rightarrow$ ULA / LoRes Offset Y
\begin{itemize}
\item[] bits 7-0 = Y Offset (0-191)(Reset to 0 after a reset)
\end{itemize}
LoRes scrolls in "half-pixels" at the same resolution and smoothness
as Layer 2.

(R/W) \$42 (66) $\Rightarrow$ ULANext Attribute Byte Format
\begin{itemize}
\item[] bits 7-0 = Mask indicating which bits of an attribute byte are
  used to represent INK. The rest will represent PAPER.
\end{itemize}
(15 on reset)\\
The mask can only indicate a solid sequence of bits on the right side
of the attribute byte (1, 3, 7, 15, 31, 63, 127 or 255).\\
INKs are mapped to base index 0 in the palette and PAPERs and border
are mapped to base index 128 in the palette.\\
The 255 value enables the full ink colour mode making all the palette
entries INK. PAPER and border both take on the fallback colour
(nextreg \$4A) in this mode.

Port \$7ffd (32765) ZX Spectrum 128 Memory\\
Disable with bit 5 port \$7ffd
\begin{itemize}
\item[] bits 6-7: reserved
\item[] bit 5: Lock memory paging (unlocks only on reset)
\item[] bit 4: ROM Select (low bit of ROM select for +2/+3)
\item[] bit 3: Shadow screen toggle
\item[] bits 0-2: Bank number for slot 4
\end{itemize}

\input{video/tilemap.tex}

\section{Layer 2}
Layer 2 is a linearly mapped, row-wise, upper left to lower right,
$256\times192\times256$ bit-map graphics area.  Both the main version
(8k pages 16-21/16k banks 8-10) and a shadow version (8k pages
22-27/16k banks 11-13) are six contiguous 8k pages (three contiguous
16k blocks) in the extended RAM space indicated by the contents of
Next registers \$12 (18 Layer 2 RAM page, default 8) and \$13 (19,
Layer 2 shadow page, default 11).  The layer 2 pages can be accessed
either by mapping the pages into normal RAM, or write only access
using port \$123B to fix them in the same space as the ROMs at
\$0000-\$3FFF.  The colours come from the indices in the layer 2
palette.  Layer 2 is drawn according to the values in registers \$16
(22, Layer 2 Offset X, default 0) and \$17 (23, Layer 2 Offset Y,
default 0).

\subsection{Programming}

Port \$123b (4667) Layer 2
\begin{itemize}
  \item[] bits 6-7: Video RAM bank select
  \item[] bit 3: Shadow layer 2 select
  \item[] bit 1: Layer 2 visible
  \item[] bit 0: Enable layer 2 write paging
\end{itemize}

For information on controlling the palette see the Palette section.

\index{transparency}
(R/W) \$14 (20) $\Rightarrow$ Global transparency color
\begin{itemize}
\item[] bits 7-0 = Transparency color value (\$E3 after a reset)
\end{itemize}
(Note: this value is 8-bit, so the transparency is compared against
only by the MSB bits of the final 9-bit colour)\\
(Note2: this only affects Layer 2, ULA and LoRes. Sprites use register
\$4B for transparency and tilemap uses nextreg \$4C)

\index{scroll offset}
(R/W) \$16 (22) $\Rightarrow$ Layer2 Offset X
\begin{itemize}
\item[] bits 7-0 = X Offset (0-255)(0 after a reset)
\end{itemize}

(R/W) \$17 (23) $\Rightarrow$ Layer2 Offset Y
\begin{itemize}
\item[] bits 7-0 = Y Offset (0-191)(0 after a reset)
\end{itemize}

\index{clip window}
(R/W) \$18 (24) $\Rightarrow$ Clip Window Layer 2
\begin{itemize}
\item[] bits 7-0 = Coords of the clip window
  \begin{itemize}
  \item[] 1st write - X1 position
  \item[] 2nd write - X2 position
  \item[] 3rd write - Y1 position
  \item[] 4rd write - Y2 position
  \end{itemize}
\end{itemize}
Reads do not advance the clip position\\
The values are 0,255,0,191 after a Reset

(W) \$1C (28) $\Rightarrow$ Clip Window control
\begin{itemize}
\item[] bits 7-4 = Reserved, must be 0
\item[] bit 3 - reset the tilemap clip index
\item[] bit 2 - reset the ULA/LoRes clip index.
\item[] bit 1 - reset the sprite clip index.
\item[] bit 0 - reset the Layer 2 clip index.
\end{itemize}

(R) \$1C (28) $\Rightarrow$ Clip Window control\\
(may change)
\begin{itemize}
\item[] bits 7-6 = Tilemap clip index
\item[] bits 5-4 = Layer 2 clip index
\item[] bits 3-2 = Sprite clip index
\item[] bits 1-0 = ULA clip index
\end{itemize}

(R/W) \$12 (18) $\Rightarrow$ Layer 2 RAM bank
\begin{itemize}
\item[] bits 7-6 = Reserved, must be 0
\item[] bits 5-0 = RAM bank (point to bank 8 after a Reset, NextZXOS
  modifies to 9)
\end{itemize}

(R/W) \$13 (19) $\Rightarrow$ Layer 2 RAM shadow bank
\begin{itemize}
\item[] bits 7-6 = Reserved, must be 0
\item[] bits 5-0 = RAM bank (point to bank 11 after a Reset, NextZXOS
  modifies to 12)
\end{itemize}

\input{video/sprites.tex}
